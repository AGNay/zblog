layui.use(["layer","form","element","slider","laypage"],(function(){"use strict";const e=layui.layer,t=layui.form,i=layui.element,n=layui.slider,a=layui.laypage;let l,o;const r=function(t){switch(l=e.open({type:1,title:!1,maxWidth:1210,maxHeight:690,scrollbar:!1,closeBtn:0,isOutAnim:!1,resize:!1,content:$("#ncmModalInserter")}),t){case 0:i.tabChange("action-tabs","add");break;case 1:i.tabChange("action-tabs","search");break;case 2:i.tabChange("action-tabs","user");break;default:i.tabChange("action-tabs","add")}},s=new NCMUSIC_ADMIN.Functions.Player;s.config={auto:0,height:66,width:700,type:2,resId:""},s.storageName="Article_NCMPlayer",s.init=function(){for(const e in this.config)if(this.liveConfig&&e in this.liveConfig)this.config[e]=this.liveConfig[e];else{const t=localStorage.getItem(this.storageName);if(null===t)this.config[e]=NCMUSIC_ADMIN.PLAYER_CONFIG.article.NCMPlayer[e];else{const i=JSON.parse(t);e in i&&(this.config[e]=i[e])}}return this.config.resId?(localStorage.setItem(this.storageName,JSON.stringify(this.config)),!0):(console.log("配置错误：无效的资源ID"),!1)},s.generate=function(e){$("#ncmPlayerPreview").length?(this.liveConfig=e,this.init()?($("#ncmPlayerPreview iframe").length&&$("#ncmPlayerPreview").remove("iframe"),NCMUSIC_ADMIN.livePlayer=document.createElement("iframe"),NCMUSIC_ADMIN.livePlayer.classList.contains("ncm-article-player")||NCMUSIC_ADMIN.livePlayer.classList.add("ncm-article-player"),NCMUSIC_ADMIN.livePlayer.style.border="0",NCMUSIC_ADMIN.livePlayer.style.width=this.config.width+"px",NCMUSIC_ADMIN.livePlayer.style.maxWidth="100%",NCMUSIC_ADMIN.livePlayer.style.height=Number(this.config.height)+20+"px",NCMUSIC_ADMIN.livePlayer.width=this.config.width,NCMUSIC_ADMIN.livePlayer.height=Number(this.config.height)+20,NCMUSIC_ADMIN.livePlayer.allow="autoplay",NCMUSIC_ADMIN.livePlayer.src="//music.163.com/outchain/player?type="+this.config.type+"&id="+this.config.resId+"&auto="+this.config.auto+"&height="+this.config.height,NCMUSIC_ADMIN.livePlayer.addEventListener("load",(function(){$("#ncmGenLoading")._hide(),$("#ncmRegenerate, #ncmInsert")._show()})),$("#ncmPlayerPreview").html(NCMUSIC_ADMIN.livePlayer),$("#ncmGenLoading")._show(),NCMUSIC_ADMIN.Functions.postConfig("player",[{key:"article.NCMPlayer.width",value:this.config.width,type:"int"}],null)):console.log("初始化失败，配置异常！",this.liveConfig,this.config)):console.log("生成失败！播放器容器元素不存在！")};const c=new NCMUSIC_ADMIN.Functions.Player;if(c.config={type:2,fixed:0,mini:0,autoplay:0,theme:"#DF2D2D",loop:0,order:0,preload:0,volume:.7,audio:"",audioCount:0,mutex:1,lrcType:0,listFolded:0,listMaxHeight:640,width:700},c.storageName="Article_APlayer",c.init=function(){for(const e in this.config)if(this.liveConfig&&e in this.liveConfig)this.config[e]=this.liveConfig[e];else{const t=localStorage.getItem(this.storageName);if(null===t)this.config[e]=NCMUSIC_ADMIN.PLAYER_CONFIG.article.APlayer[e];else{const i=JSON.parse(t);e in i&&(this.config[e]=i[e])}}return this.config.audio.length<1?(console.log("配置错误：无效的歌曲列表"),!1):(delete this.config.container,localStorage.setItem(this.storageName,JSON.stringify(this.config)),!0)},c.generate=function(e){if(!$("#aPlayerPreview").length)return void console.log("生成失败！播放器容器元素不存在！");if(this.liveConfig=e,!this.init())return void console.log("初始化失败，配置异常！",this.liveConfig,this.config);let t=76;this.config.audioCount>1&&(t=t+32*this.config.audioCount+(this.config.audioCount-1)),$("#aPlayerPreview iframe").length&&$("#aPlayerPreview").remove("iframe"),NCMUSIC_ADMIN.livePlayer=document.createElement("iframe"),NCMUSIC_ADMIN.livePlayer.classList.contains("ncm-article-aplayer")||NCMUSIC_ADMIN.livePlayer.classList.add("ncm-article-aplayer"),NCMUSIC_ADMIN.livePlayer.style.border="0",NCMUSIC_ADMIN.livePlayer.style.width=this.config.width+"px",NCMUSIC_ADMIN.livePlayer.style.maxWidth="100%",NCMUSIC_ADMIN.livePlayer.style.height=t+"px",NCMUSIC_ADMIN.livePlayer.width=this.config.width,NCMUSIC_ADMIN.livePlayer.height=t,NCMUSIC_ADMIN.livePlayer.allow="autoplay",NCMUSIC_ADMIN.livePlayer.src=NCMUSIC_ADMIN.HOME_URL+"/aplayer.php?m="+this.config.mini+"&a="+this.config.autoplay+"&t="+this.config.theme.replace("#","%23")+"&l="+this.config.loop+"&o="+this.config.order+"&p="+this.config.preload+"&v="+this.config.volume+"&lf="+this.config.listFolded+"&lm="+this.config.listMaxHeight+"&i="+this.config.audio,NCMUSIC_ADMIN.livePlayer.addEventListener("load",(function(){$("#ncmGenLoading")._hide(),$("#ncmRegenerate, #ncmInsert, #addMusic")._show()})),$("#aPlayerPreview").html(NCMUSIC_ADMIN.livePlayer),$("#ncmGenLoading")._show(),NCMUSIC_ADMIN.Functions.postConfig("player",[{key:"article.APlayer.volume",value:this.config.volume,type:"float"},{key:"article.APlayer.width",value:this.config.width,type:"int"}],null)},o=NCMUSIC_ADMIN.PLAYER_CONFIG.article.playerType?c:s,null===localStorage.getItem("Article_NCMPlayer")&&localStorage.setItem("Article_NCMPlayer",JSON.stringify(NCMUSIC_ADMIN.PLAYER_CONFIG.article.NCMPlayer)),null===localStorage.getItem("Article_APlayer")){for(const e in c.config)e in NCMUSIC_ADMIN.PLAYER_CONFIG.article.APlayer&&(c.config[e]=NCMUSIC_ADMIN.PLAYER_CONFIG.article.APlayer[e]);localStorage.setItem("Article_APlayer",JSON.stringify(c.config))}const d=function(){const e=JSON.parse(localStorage.getItem(o.storageName));for(const t in o.config)t in e&&(o.config[t]=e[t]);t.val("ncmControlForm",{articleResourceType:o.config.type,articlePlayerType:NCMUSIC_ADMIN.PLAYER_CONFIG.article.playerType}),t.val("ncmSearchForm",{type:NCMUSIC_ADMIN.PLAYER_CONFIG.searchType}),NCMUSIC_ADMIN.PLAYER_CONFIG.article.playerType?($("#ncmPlayerForm")._hide(),$("#aPlayerForm")._show(),t.val("aPlayerForm",{aPlayerAuto:e.autoplay,aPlayerMini:e.mini,aPlayerListFolded:e.listFolded,aPlayerLoop:e.loop,aPlayerOrder:e.order,aPlayerPreload:e.preload}),c.config.volume=e.volume,$("#aPlayerPreview iframe").length?$("#ncmRegenerate, #ncmInsert, #addMusic")._show():$("#ncmRegenerate, #ncmInsert, #addMusic")._hide()):($("#aPlayerForm")._hide(),$("#ncmPlayerForm")._show(),t.val("ncmPlayerForm",{ncmPlayerType:e.type,ncmPlayerAuto:e.auto,ncmPlayerHeight:e.height,ncmPlayerWidth:e.width}),0===e.type&&$("input[name='ncmPlayerHeight']").each((function(){$(this).prop("disabled","disabled"),$(this).disabled=!0})),$("#ncmPlayerPreview iframe").length?$("#ncmRegenerate, #ncmInsert")._show():$("#ncmRegenerate, #ncmInsert, #addMusic")._hide()),t.render()};d();[{name:"ncmPlayerAuto",type:"switch",key:"auto"},{name:"ncmPlayerHeight",type:"radio",key:"height"}].forEach((function(e){t.on(e.type+"("+e.name+")",(function(){let t;"switch"===e.type?t=$("input[name='"+e.name+"']").prop("checked")?1:0:"radio"===e.type&&(t=parseInt($("input[name='"+e.name+"']:checked").val())),s.setConfig(e.key,t),NCMUSIC_ADMIN.Functions.postConfig("player",[{key:"article.NCMPlayer."+e.key,value:t,type:"int"}],null)}))})),n.render({elem:"#ncmPlayerCustomWidth",min:300,max:700,value:s.config.width,step:5,theme:"#C20C0B",tips:!0,setTips:function(e){return e+"px"},change:function(e){const t=parseInt(e.substr(0,3));$("#ncmPlayerPreview > iframe").attr("width",t).css("width",t+"px"),s.setConfig("width",t)}});[{name:"aPlayerAuto",type:"switch",key:"autoplay"},{name:"aPlayerLoop",type:"radio",key:"loop"},{name:"aPlayerPreload",type:"radio",key:"preload"},{name:"aPlayerMini",type:"switch",key:"mini"},{name:"aPlayerListFolded",type:"switch",key:"listFolded"},{name:"aPlayerOrder",type:"radio",key:"order"}].forEach((function(e){t.on(e.type+"("+e.name+")",(function(){let t;"switch"===e.type?t=$("input[name='"+e.name+"']").prop("checked")?1:0:"radio"===e.type&&(t=parseInt($("input[name='"+e.name+"']:checked").val())),c.setConfig(e.key,t),NCMUSIC_ADMIN.Functions.postConfig("player",[{key:"article.APlayer."+e.key,value:t,type:"int"}],null)}))})),n.render({elem:"#aPlayerVolume",value:void 0!==c.config.volume?100*c.config.volume:70,step:10,theme:"#C20C0B",tips:!0,setTips:function(e){return e+"%"},change:function(e){c.setConfig("volume",parseFloat(e)/100)}}),n.render({elem:"#aPlayerWidth",value:c.config.width,min:300,max:700,step:10,theme:"#C20C0B",tips:!0,setTips:function(e){return e+"px"},change:function(e){const t=parseInt(e.substr(0,3));$("#aPlayerPreview > iframe").attr("width",t).css("width",t+"px"),c.setConfig("width",t)}}),t.on("radio(articlePlayerType)",(function(e){e.value!==NCMUSIC_ADMIN.PLAYER_CONFIG.article.playerType&&(NCMUSIC_ADMIN.PLAYER_CONFIG.article.playerType=parseInt(e.value),e.value?o=c:(o=s,0===o.config.type&&$("input[name='ncmPlayerHeight']").each((function(){$(this).prop("disabled","disabled"),$(this).disabled=!0}))),d(),NCMUSIC_ADMIN.Functions.postConfig("player",[{key:"article.playerType",value:e.value,type:"int"}],null))})),t.on("select(articleResourceType)",(function(i){const n=parseInt(i.value);if(isNaN(n))e.msg("请选择一个资源类型！",{icon:5,shift:6});else{const e=0===n||1===n?"disabled":"";$("input[name='ncmPlayerHeight']").each((function(){$(this).prop("disabled",e),$(this).disabled=e.length>0})),s.setConfig("type",n),c.setConfig("type",n),t.render(),NCMUSIC_ADMIN.Functions.postConfig("player",[{key:"article.NCMPlayer.type",value:n,type:"int"},{key:"article.APlayer.type",value:n,type:"int"}],null)}})),t.on("submit(analyzeMusic)",(function(t){return $.post(NCMUSIC_ADMIN.HOME_URL+"/php/api.php",{csrfToken:NCMUSIC_ADMIN.CSRF_TOKEN,action:0===o.config.type?"playlist":1===o.config.type?"album":"song",request:"detail",id:t.field.resid},(function(i){if("200"===i.code)if(NCMUSIC_ADMIN.PLAYER_CONFIG.article.playerType){let e;const n=0===c.config.type?"p":1===c.config.type?"a":"s";e=0===c.config.type?i.privileges.length:1===c.config.type?i.songs.length:1,c.generate({audio:n+t.field.resid,audioCount:e})}else{let e;e=0===s.config.type?160+30*i.privileges.length:1===s.config.type?160+30*i.songs.length:s.config.height,s.generate({resId:t.field.resid,height:e})}else console.log("解析失败，res:",i),e.msg("解析失败！请检查音乐 ID 或者资源类型是否正确！",{icon:5,shift:6})})),!1})),t.on("submit(addMusic)",(function(t){return $.post(NCMUSIC_ADMIN.HOME_URL+"/php/api.php",{csrfToken:NCMUSIC_ADMIN.CSRF_TOKEN,action:0===c.config.type?"playlist":1===c.config.type?"album":"song",request:"detail",id:t.field.resid},(function(i){if("200"===i.code){let e,n,a=0===c.config.type?"p":1===c.config.type?"a":"s";0===c.config.type?(a="p",n=i.privileges.length):1===c.config.type?(a="a",n=i.songs.length):n=1;const l=localStorage.getItem(c.storageName);null!==l&&(e=JSON.parse(l).audio),c.generate({audio:e+"_"+a+t.field.resid,audioCount:c.config.audioCount+n}),$("#ncmRegenerate").hide()}else e.msg("解析失败！请检查音乐 ID 或者资源类型是否正确！",{icon:5,shift:6})})),!1})),$("#ncmRegenerate").click((function(e){return e.preventDefault(),o.generate(),!1})),$("#ncmInsert").click((function(t){return t.preventDefault(),editor_api.editor.content.put(editor_api.editor.content.get()+NCMUSIC_ADMIN.livePlayer.outerHTML),e.close(l),!1})),t.on("submit(ncmSearchSubmit)",(function(n){let l;const o=function(r){$.post(NCMUSIC_ADMIN.HOME_URL+"/php/api.php",{csrfToken:NCMUSIC_ADMIN.CSRF_TOKEN,action:"search",request:"result",keywords:n.field.keywords,type:n.field.type,offset:void 0!==r?r-1:0},(function(d){if("200"===d.code){if("1"===n.field.type)if(void 0!==d.result){$("#ncmSearchTips").html('搜索 "'+n.field.keywords+'" ，共找到 '+d.result.songCount+" 个结果"),l='<table class="layui-table" lay-skin="line"><thead><tr><th style="width:60px">操作</th><th>标题</th><th style="width:200px">歌手</th><th style="width:265px">专辑</th><th style="width:100px">时长</th></tr></thead><tbody>';for(let e=0;e<d.result.songs.length;e++){const t=[];let i="";const n=d.result.songs[e];void 0!==n.alias[0]&&(i='<span class="alias"> - ('+n.alias[0]+")</span>");for(let e=0;e<n.artists.length;e++)t.push(n.artists[e].name);l=l+'<tr songid="'+n.id+'"><td><i class="layui-icon layui-icon-add-1 ncm-song-add" title="获取音乐 ID" style="font-size:20px"></i></td><td>'+n.name+i+"</td><td>"+t.join("/")+"</td><td>《"+n.album.name+"》</td><td>"+NCMUSIC_ADMIN.Functions.duarationFormat(n.duration)+"</td></tr>"}l+='</tbody></table><div id="ncmSearchPagebar"></div>',$("#ncmSearchResult").html(l),d.result.songCount>30&&a.render({elem:"ncmSearchPagebar",count:d.result.songCount,curr:r,limit:30,theme:"#C20C0C",jump:function(e,t){t||($("#ncmSearchResult").scrollTop(0),o(e.curr))}}),$(".ncm-song-add").click((function(){const e=$(this).parents("tr").attr("songid");t.val("ncmControlForm",{resid:e,articleResourceType:2}),$("input[name='ncmPlayerHeight']").each((function(){$(this).prop("disabled",""),$(this).disabled=!1})),s.setConfig("type",2),c.setConfig("type",2),t.render(),i.tabChange("action-tabs","add")}))}else e.msg("没有结果，换个关键词试试吧！",{icon:5,shift:6});else if("1000"===n.field.type)if(void 0!==d.result){$("#ncmSearchTips").html('搜索 "'+n.field.keywords+'" ，共找到 '+d.result.playlistCount+" 个结果"),l='<table class="layui-table" lay-skin="line"><thead><tr><th style="width:60px">操作</th><th style="width:150px">封面</th><th>标题</th><th style="width:120px">歌曲数</th><th style="width:230px">创建者</th><th style="width:100px">收藏</th><th style="width:120px">播放量</th></tr></thead><tbody>';for(let e=0;e<d.result.playlists.length;e++){let t;const i=d.result.playlists[e];t=i.playCount>1e4?Math.floor(i.playCount/1e4*100)/100+"万":i.playCount,l=l+'<tr playlistid="'+i.id+'"><td><i class="layui-icon layui-icon-add-1 ncm-playlist-add" title="获取歌单 ID" style="font-size:20px"></i></td><td><img src="'+i.coverImgUrl+'" alt="歌单封面"/></td><td>'+i.name+"</td><td>"+i.trackCount+"首</td><td>"+i.creator.nickname+"</td><td>"+i.bookCount+"</td><td>"+t+"</td></tr>"}l+='</tbody></table><div id="ncmSearchPagebar"></div>',$("#ncmSearchResult").html(l),d.result.playlistCount>30&&a.render({elem:"ncmSearchPagebar",count:d.result.playlistCount,curr:r,limit:30,theme:"#C20C0C",jump:function(e,t){t||($("#ncmSearchResult").scrollTop(0),o(e.curr))}}),$(".ncm-playlist-add").click((function(){const e=$(this).parents("tr").attr("playlistid");t.val("ncmControlForm",{resid:e,articleResourceType:0}),$("input[name='ncmPlayerHeight']").each((function(){$(this).prop("disabled","disabled"),$(this).disabled=!0})),s.setConfig("type",0),c.setConfig("type",0),t.render(),i.tabChange("action-tabs","add")}))}else e.msg("没有结果，换个关键词试试吧！",{icon:5,shift:6});else if("10"===n.field.type)if(void 0!==d.result){$("#ncmSearchTips").html('搜索 "'+n.field.keywords+'" ，共找到 '+d.result.albumCount+" 个结果"),l='<table class="layui-table" lay-skin="line"><thead><tr><th style="width:60px">操作</th><th style="width:150px">封面</th><th>标题</th><th style="width:250px">艺术家</th><th style="width:120px">歌曲数</th><th style="width:120px">发行日期</th></tr></thead><tbody>';for(let e=0;e<d.result.albums.length;e++){const t=[],i=d.result.albums[e];for(let e=0;e<i.artists.length;e++)t.push(i.artists[e].name);l=l+'<tr albumid="'+i.id+'"><td><i class="layui-icon layui-icon-add-1 ncm-album-add" title="获取专辑 ID" style="font-size:20px"></i></td><td><img src="'+i.picUrl+'" alt="专辑封面"/></td><td>'+i.name+"</td><td>"+t.join("/")+"</td><td>"+i.size+"首</td><td>"+NCMUSIC_ADMIN.publishTimeFormat(i.publishTime)+"</td></tr>"}l+='</tbody></table><div id="ncmSearchPagebar"></div>',$("#ncmSearchResult").html(l),d.result.albumCount>30&&a.render({elem:"ncmSearchPagebar",count:d.result.albumCount,curr:r,limit:30,theme:"#C20C0C",jump:function(e,t){t||($("#ncmSearchResult").scrollTop(0),o(e.curr))}}),$(".ncm-album-add").click((function(){const e=$(this).parents("tr").attr("albumid");t.val("ncmControlForm",{resid:e,articleResourceType:1}),$("input[name='ncmPlayerHeight']").each((function(){$(this).prop("disabled","disabled"),$(this).disabled=!0})),s.setConfig("type",1),c.setConfig("type",1),t.render(),i.tabChange("action-tabs","add")}))}else e.msg("没有结果，换个关键词试试吧！",{icon:5,shift:6})}else console.log("网易云音乐插件 search response:",d),e.msg("搜索失败！详情查看控制台日志。",{icon:5,shift:6})}))};return o(),!1})),$("#ncmBtnInsert").click((function(){r(0)})),$("#ncmBtnSearch").click((function(){r(1)})),$("#ncmBtnUserlike").click((function(){r(2)})),$("#ncmInsClose").click((function(){e.close(l)})),$("#officialLink").click((function(){window.open("https://music.163.com/","_blank")}))}));
//# sourceMappingURL=admin-edit.min.js.map

layui.use(["layer","form","element","slider","laypage"],(function(){"use strict";const e=layui.layer,t=layui.form,o=layui.element,n=layui.slider,i=layui.laypage,l=location.hash.replace(/^#tabs=/,"");o.tabChange("main-tabs",l),o.on("tab(main-tabs)",(function(){location.hash="tabs="+this.getAttribute("lay-id"),$(this).siblings().children("i.cor").removeClass("arrow"),$(this).children("i.cor").addClass("arrow")}));const a=new NCMUSIC_ADMIN.Functions.Player;a.config={type:2,autoplay:0,theme:"#DF2D2D",loop:0,order:0,preload:0,volume:.7,audio:[],lrcType:0,audioSto:[]},a.storageName="Global_APlayer",a.init=function(){for(const e in this.config)if(void 0!==this.liveConfig&&e in this.liveConfig)this.config[e]=this.liveConfig[e];else{const t=localStorage.getItem(this.storageName);if(null===t)this.config[e]=NCMUSIC_ADMIN.PLAYER_CONFIG.article.APlayer[e];else{const o=JSON.parse(t);e in o&&(this.config[e]=o[e])}}return this.config.audio.length<1?(console.log("配置错误：无效的歌曲列表",this.config),!1):(localStorage.setItem(this.storageName,JSON.stringify(this.config)),!0)},a.generate=function(t){const o=$("#aPlayerPreview");o.length?(this.liveConfig=t,this.init()?(NCMUSIC_ADMIN.livePlayer instanceof APlayer&&(NCMUSIC_ADMIN.livePlayer.destroy(),NCMUSIC_ADMIN.livePlayer=null,o.removeClass().empty()),NCMUSIC_ADMIN.livePlayer=new APlayer({container:document.getElementById("aPlayerPreview"),fixed:!0,autoplay:1===this.config.autoplay,theme:this.config.theme,loop:2===this.config.loop?"all":1===this.config.loop?"one":"none",order:1===this.config.order?"random":"list",preload:2===this.config.preload?"auto":1===this.config.preload?"metadata":"none",volume:this.config.volume,mutex:1,lrcType:0,audio:this.config.audio}),o.html().length&&($("#ncmRegenerate, #addMusic")._show(),e.msg("请查看网页左下角的预览效果",{icon:6,shift:6}),o.hasClass("aplayer-arrow")&&o.removeClass("aplayer-arrow"))):console.log("初始化失败，配置异常！",this.liveConfig,this.config)):console.log("生成失败！播放器容器元素不存在！")};[{name:"aPlayerAuto",type:"switch",key:"autoplay"},{name:"aPlayerLoop",type:"radio",key:"loop"},{name:"aPlayerPreload",type:"radio",key:"preload"},{name:"aPlayerOrder",type:"radio",key:"order"}].forEach((function(e){t.on(e.type+"("+e.name+")",(function(){let t;"switch"===e.type?t=$("input[name='"+e.name+"']").prop("checked")?1:0:"radio"===e.type&&(t=parseInt($("input[name='"+e.name+"']:checked").val())),a.setConfig(e.key,t)}))})),n.render({elem:"#aPlayerVolume",value:void 0!==a.config.volume?100*a.config.volume:70,step:10,theme:"#C20C0B",tips:!0,setTips:function(e){return e+"%"},change:function(e){a.setConfig("volume",parseFloat(e)/100)}}),t.on("select(resourceType)",(function(t){const o=parseInt(t.value);isNaN(o)?e.msg("请选择一个资源类型！",{icon:5,shift:6}):a.setConfig("type",o)}));const s=function(t){$.post(NCMUSIC_ADMIN.HOME_URL+"/php/api.php",{csrfToken:NCMUSIC_ADMIN.CSRF_TOKEN,action:0===a.config.type?"playlist":1===a.config.type?"album":"song",request:"url",id:t},(function(o){if("200"===o.code){const e=[],n=function(t){for(let o=0;o<t.ar.length;o++)e.push(t.ar[o].name);a.config.audio.push({name:t.name,artist:e.join("/"),url:void 0!==t.url.url?t.url.url:t.url,cover:t.al.picUrl})};0===a.config.type?(a.setConfig("audioSto",a.config.audioSto.concat("p"+t)),o.playlist.tracks.forEach((function(t){n(t),e.splice(0,e.length)}))):1===a.config.type?(a.setConfig("audioSto",a.config.audioSto.concat("a"+t)),o.songs.forEach((function(t){n(t),e.splice(0,e.length)}))):(a.setConfig("audioSto",a.config.audioSto.concat("s"+t)),n(o.songs[0])),a.generate({audio:a.config.audio})}else console.log("解析失败，res:",o),e.msg("解析失败！请检查音乐 ID 或者资源类型是否正确！",{icon:5,shift:6})}))};t.on("submit(analyzeMusic)",(function(e){return a.config.audio.splice(0,a.config.audio.length),a.config.audioSto.splice(0,a.config.audioSto.length),s(e.field.resid),!1})),t.on("submit(addMusic)",(function(e){return s(e.field.resid),!1})),$("#ncmRegenerate").click((function(e){return e.preventDefault(),a.generate({audio:a.config.audio}),!1})),t.on("submit(ncmSearchSubmit)",(function(n){let l;const s=function(r){$.post(NCMUSIC_ADMIN.HOME_URL+"/php/api.php",{csrfToken:NCMUSIC_ADMIN.CSRF_TOKEN,action:"search",request:"result",keywords:n.field.keywords,type:n.field.type,offset:void 0!==r?r-1:0},(function(c){if("200"===c.code){if("1"===n.field.type)if(void 0!==c.result){$("#ncmSearchTips").html('搜索 "'+n.field.keywords+'" ，共找到 '+c.result.songCount+" 个结果"),l='<table class="layui-table" lay-skin="line"><thead><tr><th style="width:60px">操作</th><th>标题</th><th style="width:200px">歌手</th><th style="width:265px">专辑</th><th style="width:100px">时长</th></tr></thead><tbody>';for(let e=0;e<c.result.songs.length;e++){const t=[];let o="";const n=c.result.songs[e];void 0!==n.alias[0]&&(o='<span class="alias"> - ('+n.alias[0]+")</span>");for(let e=0;e<n.artists.length;e++)t.push(n.artists[e].name);l=l+'<tr songid="'+n.id+'"><td><i class="layui-icon layui-icon-add-1 ncm-song-add" title="获取音乐 ID" style="font-size:20px"></i></td><td>'+n.name+o+"</td><td>"+t.join("/")+"</td><td>《"+n.album.name+"》</td><td>"+NCMUSIC_ADMIN.Functions.duarationFormat(n.duration)+"</td></tr>"}l+='</tbody></table><div id="ncmSearchPagebar"></div>',$("#ncmSearchResult").html(l),c.result.songCount>30&&i.render({elem:"ncmSearchPagebar",count:c.result.songCount,curr:r,limit:30,theme:"#C20C0C",jump:function(e,t){t||($("#ncmSearchResult").scrollTop(0),s(e.curr))}}),$(".ncm-song-add").click((function(){const e=$(this).parents("tr").attr("songid");t.val("global",{resid:e,resourceType:2}),a.setConfig("type",2),t.render(),o.tabChange("gPlayerControlTabs","gPlayerConfig")}))}else e.msg("没有结果，换个关键词试试吧！",{icon:5,shift:6});else if("1000"===n.field.type)if(void 0!==c.result){$("#ncmSearchTips").html('搜索 "'+n.field.keywords+'" ，共找到 '+c.result.playlistCount+" 个结果"),l='<table class="layui-table" lay-skin="line"><thead><tr><th style="width:60px">操作</th><th style="width:150px">封面</th><th>标题</th><th style="width:120px">歌曲数</th><th style="width:230px">创建者</th><th style="width:100px">收藏</th><th style="width:120px">播放量</th></tr></thead><tbody>';for(let e=0;e<c.result.playlists.length;e++){let t;const o=c.result.playlists[e];t=o.playCount>1e4?Math.floor(o.playCount/1e4*100)/100+"万":o.playCount,l=l+'<tr playlistid="'+o.id+'"><td><i class="layui-icon layui-icon-add-1 ncm-playlist-add" title="获取歌单 ID" style="font-size:20px"></i></td><td><img src="'+o.coverImgUrl+'" alt="歌单封面"/></td><td>'+o.name+"</td><td>"+o.trackCount+"首</td><td>"+o.creator.nickname+"</td><td>"+o.bookCount+"</td><td>"+t+"</td></tr>"}l+='</tbody></table><div id="ncmSearchPagebar"></div>',$("#ncmSearchResult").html(l),c.result.playlistCount>30&&i.render({elem:"ncmSearchPagebar",count:c.result.playlistCount,curr:r,limit:30,theme:"#C20C0C",jump:function(e,t){t||($("#ncmSearchResult").scrollTop(0),s(e.curr))}}),$(".ncm-playlist-add").click((function(){const e=$(this).parents("tr").attr("playlistid");t.val("global",{resid:e,resourceType:0}),a.setConfig("type",0),t.render(),o.tabChange("gPlayerControlTabs","gPlayerConfig")}))}else e.msg("没有结果，换个关键词试试吧！",{icon:5,shift:6});else if("10"===n.field.type)if(void 0!==c.result){$("#ncmSearchTips").html('搜索 "'+n.field.keywords+'" ，共找到 '+c.result.albumCount+" 个结果"),l='<table class="layui-table" lay-skin="line"><thead><tr><th style="width:60px">操作</th><th style="width:150px">封面</th><th>标题</th><th style="width:250px">艺术家</th><th style="width:120px">歌曲数</th><th style="width:120px">发行日期</th></tr></thead><tbody>';for(let e=0;e<c.result.albums.length;e++){const t=[],o=c.result.albums[e];for(let e=0;e<o.artists.length;e++)t.push(o.artists[e].name);l=l+'<tr albumid="'+o.id+'"><td><i class="layui-icon layui-icon-add-1 ncm-album-add" title="获取专辑 ID" style="font-size:20px"></i></td><td><img src="'+o.picUrl+'" alt="专辑封面"/></td><td>'+o.name+"</td><td>"+t.join("/")+"</td><td>"+o.size+"首</td><td>"+NCMUSIC_ADMIN.Functions.publishTimeFormat(o.publishTime)+"</td></tr>"}l+='</tbody></table><div id="ncmSearchPagebar"></div>',$("#ncmSearchResult").html(l),c.result.albumCount>30&&i.render({elem:"ncmSearchPagebar",count:c.result.albumCount,curr:r,limit:30,theme:"#C20C0C",jump:function(e,t){t||($("#ncmSearchResult").scrollTop(0),s(e.curr))}}),$(".ncm-album-add").click((function(){const e=$(this).parents("tr").attr("albumid");t.val("global",{resid:e,resourceType:1}),a.setConfig("type",1),t.render(),o.tabChange("gPlayerControlTabs","gPlayerConfig")}))}else e.msg("没有结果，换个关键词试试吧！",{icon:5,shift:6})}else console.log("网易云音乐插件 search response:",c),e.msg("搜索失败！详情查看控制台日志。",{icon:5,shift:6})}))};return s(),!1})),t.on("submit(articleForm)",(function(t){const o=[{key:"article.analyzeUrl",value:0,type:"int"},{key:"article.widgetSize",value:0,type:"int"},{key:"article.playerType",value:0,type:"int"}];return void 0!==t.field.analyzeUrl&&"on"===t.field.analyzeUrl&&(o[0].value=1),"1"===t.field.widgetSize&&(o[1].value=1),"1"===t.field.articlePlayerType&&(o[2].value=1),NCMUSIC_ADMIN.Functions.postConfig("player",o,(function(t){e.open({title:"操作提示",content:t[1],shadeClose:!0,yes:function(t){e.close(t)}})})),!1})),t.on("submit(globalForm)",(function(t){const o=[{key:"global.status",value:0,type:"int"},{key:"global.gapless",value:t.field.gapless,type:"int"},{key:"global.APlayer.type",value:a.config.type,type:"int"},{key:"global.APlayer.autoplay",value:a.config.autoplay,type:"int"},{key:"global.APlayer.loop",value:a.config.loop,type:"int"},{key:"global.APlayer.order",value:a.config.order,type:"int"},{key:"global.APlayer.preload",value:a.config.preload,type:"int"},{key:"global.APlayer.volume",value:a.config.volume,type:"float"},{key:"global.APlayer.audioSto",value:a.config.audioSto.join("_"),type:"string"}];return void 0!==t.field.status&&"on"===t.field.status&&(o[0].value=1),NCMUSIC_ADMIN.Functions.postConfig("player",o,(function(t){e.open({title:"操作提示",content:t[1],shadeClose:!0,yes:function(t){e.close(t)}})})),!1})),t.on("submit(othersForm)",(function(t){const o=void 0!==t.field.keepconfig&&"on"===t.field.keepconfig?1:0,n="1000"===t.field.searchType?1e3:"10"===t.field.searchType?10:1;return NCMUSIC_ADMIN.Functions.postConfig("player",[{key:"searchType",value:n,type:"int"}],(function(e){console.log("Post searchType done:",e)})),NCMUSIC_ADMIN.Functions.postConfig("plugin",[{key:"keepconfig",value:o,type:"int"}],(function(t){e.open({title:"操作提示",content:t[1],shadeClose:!0,yes:function(t){e.close(t)}})})),!1})),t.on("submit(reset)",(function(){return e.confirm("请谨慎操作！是否重置本插件的所有设置？",{btn:["确认","取消"],yes:function(t){e.close(t),$.get(`php/config.php?action=migrate&csrfToken=${NCMUSIC_ADMIN.CSRF_TOKEN}`,(function(t){e.open({title:"操作提示",content:t[1],shadeClose:!0,yes:function(t){e.close(t)}})}))},btn2:function(t){e.close(t)}}),!1})),t.on("submit(clearcache)",(function(){return e.confirm("是否清空所有的音乐缓存？",{btn:["确认","取消"],yes:function(t){e.close(t),$.get("php/config.php?action=clearcache&csrfToken="+NCMUSIC_ADMIN.CSRF_TOKEN,(function(t){e.open({title:"操作提示",content:t[1],shadeClose:!0,yes:function(t){e.close(t)}})}))},btn2:function(t){e.close(t)}}),!1})),t.on("submit(migrate)",(function(){return e.confirm("是否从 v1.x 版本迁移数据？",{btn:["确认","取消"],yes:function(t){e.close(t),$.get(`php/config.php?action=migrate&csrfToken=${NCMUSIC_ADMIN.CSRF_TOKEN}`,(function(t){e.open({title:"操作提示",content:t[1],shadeClose:!0,yes:function(t){e.close(t)}})}))},btn2:function(t){e.close(t)}}),!1}));let r=localStorage.getItem(a.storageName);if(null===r){const e=NCMUSIC_ADMIN.PLAYER_CONFIG.global.APlayer;e.audioSto?e.audioSto=e.audioSto.split("_"):e.audioSto=[],r=JSON.stringify(e),localStorage.setItem(a.storageName,r)}const c=JSON.parse(r);"audio"in c&&c.audio.length>0&&c.audio.splice(0,c.audio.length);for(const e in a.config)e in c&&(a.config[e]=c[e]);if(t.val("article",{analyzeUrl:NCMUSIC_ADMIN.PLAYER_CONFIG.article.analyzeUrl,widgetSize:NCMUSIC_ADMIN.PLAYER_CONFIG.article.widgetSize,articlePlayerType:NCMUSIC_ADMIN.PLAYER_CONFIG.article.playerType}),t.val("global",{status:NCMUSIC_ADMIN.PLAYER_CONFIG.global.status,gapless:NCMUSIC_ADMIN.PLAYER_CONFIG.global.gapless,resourceType:c.type,aPlayerAuto:c.autoplay,aPlayerLoop:c.loop,aPlayerOrder:c.order,aPlayerPreload:c.preload}),a.config.volume=c.volume,c.audioSto&&NCMUSIC_ADMIN.PLAYER_CONFIG.global.status){const e=[],t=[],o=t=>new Promise((o,n)=>{const i=new XMLHttpRequest,l="p"===t.substr(0,1)?"playlist":"a"===t.substr(0,1)?"album":"song";i.onload=t=>{if(4===t.currentTarget.readyState&&200===t.currentTarget.status){const n=JSON.parse(t.currentTarget.response),i=[],a=t=>{for(const e in t.ar)i.push(t.ar[e].name);e.push({name:t.name,artist:i.join("/"),url:void 0!==t.url.url?t.url.url:t.url,cover:t.al.picUrl})};"playlist"===l?n.playlist.tracks.forEach(e=>{a(e),i.splice(0,i.length)}):"album"===l?n.songs.forEach(e=>{a(e),i.splice(0,i.length)}):a(n.songs[0]),o()}else n(t.currentTarget)},i.open("POST",`${NCMUSIC_ADMIN.HOME_URL}/php/api.php`),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.send(`csrfToken=${NCMUSIC_ADMIN.CSRF_TOKEN}&action=${l}&request=url&id=${t.substr(1)}`)});c.audioSto.forEach(e=>{t.push(o(e))}),Promise.all(t).then(()=>{a.config.audio=e,a.generate(a.config)},e=>{console.error("网易云音乐插件请求出错！",e)})}$("#aPlayerPreview").hasClass("aplayer")?$("#ncmRegenerate, #addMusic")._show():$("#ncmRegenerate, #addMusic")._hide(),t.val("others",{searchType:NCMUSIC_ADMIN.PLAYER_CONFIG.searchType,keepconfig:NCMUSIC_ADMIN.PLUGIN_CONFIG.keepconfig}),t.render()})),$(document).ready((function(){$(window).keydown((function(e){if(13===e.keyCode)return e.preventDefault(),!1}))}));
//# sourceMappingURL=admin-setting.min.js.map
